version: '3.8'

services:
  gemini-proxy:
    build: .
    container_name: gemini-proxy-service
    restart: always
    ports:
      - "8000:8000"
    environment:
      # [Task 3.1] 移除硬编码凭据，改为环境变量插值
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - TZ=Asia/Shanghai
      - GATEWAY_SECRET=${GATEWAY_SECRET}
      - AUTO_REPLACEMENT_WEBHOOK=${AUTO_REPLACEMENT_WEBHOOK}
    volumes:
      - ./config.json:/app/config.json
    depends_on:
      - redis
      - prometheus
    networks:
      - backend-network
      - default
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    # [Task 3.2] 添加资源限制，防止单点故障耗尽宿主机资源
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 128M

  redis:
    image: redis:7.0-alpine
    container_name: gemini-proxy-redis
    restart: always
    # [Task 3.1] 使用环境变量注入密码，避免直接硬编码在 yaml 中
    # 注意：在生产环境中，为了彻底防止 ps 命令泄露，建议挂载 redis.conf 配置文件
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - redis_data:/data
    networks:
      - backend-network
    # [Task 3.2] Redis 通常占用较低，给予适当限制即可
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  prometheus:
    image: prom/prometheus:latest
    container_name: gemini-proxy-prometheus
    restart: always
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      # [Task 3.3] 收敛攻击面：仅绑定到 127.0.0.1，禁止公网直接访问
      - "127.0.0.1:9090:9090"
    networks:
      - default

  grafana:
    image: grafana/grafana:latest
    container_name: gemini-proxy-grafana
    restart: always
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      # [Task 3.3] 收敛攻击面：仅绑定到 127.0.0.1
      - "127.0.0.1:3000:3000"
    networks:
      - default

volumes:
  redis_data:
  prometheus_data:
  grafana_data:

networks:
  backend-network:
    internal: true
  default:
    external: false
